# P2P Hosting Support Patch for WARP Client

# File patches to enable P2P hosting support
patches:
  # Core network handling modifications
  - file: Core/Network/NetworkManager.cpp
    changes:
      - operation: add
        before: "class NetworkManager {"
        content: |
          // P2P networking support
          #include "P2PNetwork.hpp"
          #include "P2PSession.hpp"
          
      - operation: add
        after: "private:"
        content: |
          std::unique_ptr<P2PNetwork> p2p_network_;
          std::unordered_map<uint32_t, std::shared_ptr<P2PSession>> p2p_sessions_;
          
      - operation: add
        after: "public:"
        content: |
          // P2P network handling
          bool connect_to_p2p_host(const std::string& address, uint16_t port);
          void disconnect_from_p2p_host(uint32_t host_id);
          void handle_p2p_packet(const NetworkPacket& packet);
          void update_p2p_connections();

  # P2P Network implementation
  - file: Core/Network/P2PNetwork.hpp
    create: true
    content: |
      #pragma once
      #include <string>
      #include <memory>
      #include "NetworkTypes.hpp"
      
      class P2PNetwork {
      public:
          bool initialize();
          bool connect(const std::string& address, uint16_t port);
          void disconnect();
          bool send_packet(const NetworkPacket& packet);
          void update();
          
          // Connection state
          bool is_connected() const { return connected_; }
          uint32_t get_latency() const { return latency_; }
          SystemMetrics get_metrics() const;
          bool meets_host_requirements() const;
          void update_performance_metrics();
          
      private:
          bool connected_ = false;
          uint32_t latency_ = 0;
          
          // Network sockets and buffers
          // Implementation details
          
          // Performance monitoring
          SystemMetrics metrics_;
          uint32_t cpu_cores_;
          float cpu_frequency_;
          uint64_t total_memory_;
          uint32_t network_speed_;
      };

  # P2P Session management
  - file: Core/Network/P2PSession.hpp
    create: true
    content: |
      #pragma once
      #include <chrono>
      #include "NetworkTypes.hpp"
      #include "../Crypto/Encryption.hpp"
      
      class P2PSession {
      public:
          P2PSession(uint32_t host_id);
          
          // Session management
          bool initialize(const std::string& auth_token);
          void update();
          bool is_active() const;
          
          // Packet handling
          bool send_packet(const NetworkPacket& packet);
          void handle_packet(const NetworkPacket& packet);
          
          // Security
          bool verify_packet(const NetworkPacket& packet);
          void rotate_keys();
          
      private:
          uint32_t host_id_;
          std::string auth_token_;
          EncryptionContext encryption_;
          std::chrono::system_clock::time_point last_activity_;
      };

  # Map system modifications
  - file: Core/Game/MapSystem.cpp
    changes:
      - operation: add
        after: "void MapSystem::load_map("
        content: |
          // Check P2P-first preference
          if (config_.prefer_p2p_hosting && !map_info.is_critical) {
              // Try to find P2P host first
              auto p2p_host = find_best_p2p_host(map_id);
              if (p2p_host) {
                  try {
                      connect_to_p2p_host(p2p_host->address, p2p_host->port);
                      initialize_p2p_map_session(map_id, p2p_host->id);
                      return;
                  } catch (const std::exception& e) {
                      log_warning("P2P connection failed: {}", e.what());
                  }
              }
              
              // Fall back to main server if enabled
              if (!config_.main_server_fallback) {
                  throw std::runtime_error("No P2P host available and main server fallback disabled");
              }
          }
          
          // Check if map is P2P hosted
          if (is_p2p_map(map_id)) {
              auto current_host = get_p2p_host(map_id);
              if (!current_host) {
                  throw std::runtime_error("No host available for map");
              }
              
              // Connect to P2P host
              try {
                  connect_to_p2p_host(current_host->address, current_host->port);
                  initialize_p2p_map_session(map_id, current_host->id);
              } catch (const std::exception& e) {
                  handle_p2p_host_failure(map_id, current_host->id);
                  throw;
              }
          }
          
      - operation: add
        after: "class MapSystem {"
        content: |
          private:
            HostInfo* find_best_p2p_host(map_id_t map_id);
            void handle_p2p_host_failure(map_id_t map_id, host_id_t host_id);
            bool validate_host_requirements(const SystemMetrics& metrics) const;
            void update_host_metrics();

  # Packet handling modifications
  - file: Core/Network/PacketHandler.cpp
    changes:
      - operation: add
        after: "void PacketHandler::register_handlers()"
        content: |
          // P2P packet handlers
          register_handler(PACKET_P2P_AUTH, &PacketHandler::handle_p2p_auth);
          register_handler(PACKET_P2P_MAP_DATA, &PacketHandler::handle_p2p_map_data);
          register_handler(PACKET_P2P_ENTITY_UPDATE, &PacketHandler::handle_p2p_entity_update);
          register_handler(PACKET_P2P_PLAYER_ACTION, &PacketHandler::handle_p2p_player_action);

# Configuration file updates
  - file: Data/config.ini
    changes:
      - operation: add
        at: end
        content: |
          [P2P]
          ; P2P hosting configuration
          EnableP2P=1
          PreferP2PHosting=1
          MainServerFallback=1

          ; Host Requirements
          MinCPUCores=4
          MinCPUFrequency=3000
          MinMemoryMB=8192
          MinNetworkSpeedMbps=100
          MaxLatencyMS=100

          ; Security settings
          EnableEncryption=1
          KeyRotationInterval=3600

          ; Performance settings
          CompressionThreshold=1024
          UpdateInterval=50
          MaxConnections=5

# Resource updates
  - file: Data/resourceinfo.ini
    changes:
      - operation: add
        after: "[CONNECTION]"
        content: |
          [P2P_HOSTS]
          0=coordinator.example.com:5121
          1=backup-coordinator.example.com:5121

# New files
files:
  - path: Core/Network/P2PNetwork.cpp
    content: >
      #include "P2PNetwork.hpp"
      // Implementation of P2P networking functionality
      
  - path: Core/Network/P2PSession.cpp
    content: |
      #include "P2PSession.hpp"
      // Implementation of P2P session management
      
  - path: Core/Game/P2PMapSession.hpp
    content: |
       #pragma once
       #include "MapTypes.hpp"
       // P2P map session header
      
  - path: Core/Game/P2PMapSession.cpp
    content: |
       #include "P2PMapSession.hpp"
       // Implementation of P2P map session management

  - path: Core/Game/MapSystem_P2P.cpp
    content: |
       #include "MapSystem.hpp"
       #include "P2PNetwork.hpp"
       #include "Config.hpp"
       
       HostInfo* MapSystem::find_best_p2p_host(map_id_t map_id) {
           std::vector<HostInfo*> eligible_hosts;
           
           // Get list of available hosts
           auto hosts = coordinator_->get_map_hosts(map_id);
           for (auto* host : hosts) {
               if (!host->is_vps && validate_host_requirements(host->metrics)) {
                   eligible_hosts.push_back(host);
               }
           }
           
           if (eligible_hosts.empty()) {
               return nullptr;
           }
           
           // Sort by latency and performance score
           std::sort(eligible_hosts.begin(), eligible_hosts.end(),
               [](const HostInfo* a, const HostInfo* b) {
                   float a_score = a->metrics.network_latency * 0.7f + 
                                 (100.0f - a->performance_score) * 0.3f;
                   float b_score = b->metrics.network_latency * 0.7f + 
                                 (100.0f - b->performance_score) * 0.3f;
                   return a_score < b_score;
               });
           
           return eligible_hosts[0];
       }
       
       bool MapSystem::validate_host_requirements(const SystemMetrics& metrics) const {
           const auto& config = Config::get().p2p;
           
           return metrics.cpu_cores >= config.min_cpu_cores &&
                  metrics.cpu_frequency >= config.min_cpu_frequency &&
                  metrics.free_memory >= config.min_memory_mb * 1024 * 1024 &&
                  metrics.bandwidth >= config.min_network_speed_mbps * 1024 * 1024 / 8 &&
                  metrics.network_latency <= config.max_latency_ms;
       }
       
       void MapSystem::handle_p2p_host_failure(map_id_t map_id, host_id_t host_id) {
           log_warning("P2P host {} failed for map {}", host_id, map_id);
           coordinator_->report_host_failure(host_id);
           trigger_host_migration(map_id);
       }
       
       void MapSystem::update_host_metrics() {
           SystemMetrics metrics;
           metrics.cpu_cores = get_cpu_cores();
           metrics.cpu_frequency = get_cpu_frequency();
           metrics.free_memory = get_free_memory();
           metrics.bandwidth = measure_network_speed();
           metrics.network_latency = measure_network_latency();
           
           p2p_network_->update_metrics(metrics);
       }

build:
  # Additional build system modifications
  cmake:
    - target: Client
      sources:
        - Core/Network/P2PNetwork.cpp
        - Core/Network/P2PSession.cpp
        - Core/Game/P2PMapSession.cpp
          - Core/Game/MapSystem_P2P.cpp
      definitions:
        - ENABLE_P2P_SUPPORT

  # Linker settings
  linker:
    libraries:
      - ssl
      - crypto
      - z

# Dependencies
dependencies:
  - OpenSSL >= 1.1.1
  - zlib >= 1.2.11

# Documentation
docs:
  - title: P2P Client Implementation
    file: doc/p2p_client.md
    sections:
      - Overview
      - Network Protocol
      - Security Measures
      - Configuration
      - Troubleshooting