# Universal P2P Integration Patch
# Enables both client and host functionality automatically
name: universal_p2p
description: Built-in P2P functionality with automatic role selection
version: 1.0.0

# Core functionality
components:
  network_monitor:
    type: built_in
    priority: high
    auto_start: true

  host_capabilities:
    type: built_in
    auto_enable: true
    dynamic: true

# Runtime patches
patches:
  # Add universal P2P capabilities
  - target: "Client::Initialize"
    offset: 0x1A4000
    type: inject
    code: |
      push ebp
      mov ebp, esp
      call InitUniversalP2P   ; Initialize P2P system
      test eax, eax
      jz regular_mode
      
      ; Check system capabilities
      call CheckHostCapability
      test eax, eax
      jz client_only_mode
      
      ; System can host - enable full functionality
      push HOST_AND_CLIENT
      call EnableP2PModes
      jmp done
      
      client_only_mode:
      push CLIENT_ONLY
      call EnableP2PModes
      jmp done
      
      regular_mode:
      push REGULAR_MODE
      call EnableP2PModes
      
      done:
      pop ebp
      ret

  # Add automatic network quality monitoring
  - target: "Network::Process"
    offset: 0x1A5F00
    type: append
    code: |
      push ebp
      mov ebp, esp
      
      ; Monitor network metrics
      call UpdateNetworkMetrics
      
      ; Check if we can upgrade to host
      call CheckHostEligibility
      test eax, eax
      jz check_downgrade
      
      ; Enable host mode if not active
      call IsHostMode
      test eax, eax
      jnz done_check
      call EnableHostMode
      jmp done_check
      
      check_downgrade:
      ; Disable host mode if active
      call IsHostMode
      test eax, eax
      jz done_check
      call DisableHostMode
      
      done_check:
      pop ebp
      ret

# Built-in network monitoring
functions:
  CheckHostCapability:
    type: internal
    code: |
      ; Check system requirements
      call CheckCPUCapability
      test eax, eax
      jz not_capable
      
      call CheckMemoryAvailable
      test eax, eax
      jz not_capable
      
      call CheckNetworkCapability
      test eax, eax
      jz not_capable
      
      mov eax, 1
      ret
      
      not_capable:
      xor eax, eax
      ret

  UpdateNetworkMetrics:
    type: internal
    code: |
      ; Monitor all network metrics
      call MeasureJitter
      mov [network_metrics.jitter], eax
      
      call MeasureLatency
      mov [network_metrics.latency], eax
      
      call MeasureBandwidthIn
      mov [network_metrics.bandwidth_in], eax
      
      call MeasureBandwidthOut
      mov [network_metrics.bandwidth_out], eax
      
      call MeasurePacketLoss
      mov [network_metrics.packet_loss], eax
      
      call CheckDDoSPatterns
      mov [network_metrics.under_attack], eax
      test eax, eax
      
      call UpdateNetworkStatus
      ret

# Configuration
settings:
  thresholds:
    map_host_requirements:     # Requirements for players who want to host maps
      description: "System and network requirements for hosting game maps"
      min_cpu_score: 1000
      min_memory_mb: 1024
      min_bandwidth_in_mbps: 50  # Must have 100Mbps download
      min_bandwidth_out_mbps: 25   # Must have 50Mbps upload  
      max_latency_ms: 50          # Must have <50ms latency
      max_jitter_ms: 20          # Must have stable connection
      max_packet_loss: 1.0       # Maximum acceptable packet loss percentage

  monitoring:
    check_interval_ms: 1000
    metrics_window: 60
    auto_adjust: true

  modes:
    instant_switch: false
    grace_period_sec: 30
    require_stable: true
    
    round_robin:
      description: "Controls how map hosting duties are distributed"
      enabled: true              # Enable round-robin restoration
      check_interval_sec: 30     # Check interval
      min_stable_time_sec: 300   # Minimum time before role change
    
    ddos_protection:
      description: "DDoS attack detection and mitigation settings"
      enabled: true
      detection_window_sec: 10   # DDoS detection window 
      blacklist_duration_sec: 3600
      attack_thresholds: {
        max_connections_per_sec: 500  # Alert if exceeded
        max_packets_per_sec: 10000    # Alert if exceeded
      }

# Status reporting
ui:
  status_indicator:
    enabled: true
    position: "top_right"
    show:
      mode: true
      metrics: true
      role: true

  notifications:
    mode_changes: true
    performance_warnings: true
    role_changes: true

# Security  
security:
  encryption: true
  authentication: true
  integrity_check: true
  secure_handshake: true
  ddos_protection: true

# Performance
performance:
  adaptive_quality: true
  dynamic_scaling: true
  resource_management: true
  
  network_quality:
    measure_jitter: true
    bandwidth_monitoring: true
    connection_tracking: true
  
# Error handling
error_handling:
  auto_recovery: true
  fallback_mode: true
  error_reporting: true
  
# Logging
logging:
  level: "info"
  metrics_enabled: true
  performance_tracking: true
  rotate: true
  max_size: "10MB"