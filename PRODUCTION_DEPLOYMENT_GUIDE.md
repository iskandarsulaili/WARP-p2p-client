# Production Deployment Guide

**Version**: 1.0  
**Date**: 2025-11-07  
**Project**: WARP P2P Client - Production Deployment

---

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [P2P Coordinator Deployment](#p2p-coordinator-deployment)
3. [SSL/TLS Configuration](#ssltls-configuration)
4. [Client Integration](#client-integration)
5. [Monitoring and Logging](#monitoring-and-logging)
6. [Rollback Procedures](#rollback-procedures)
7. [Disaster Recovery](#disaster-recovery)

---

## Prerequisites

### Infrastructure Requirements
- **P2P Coordinator Server**:
  - OS: Ubuntu 22.04 LTS or later
  - CPU: 4+ cores
  - RAM: 8GB+ (16GB recommended for 50+ peers)
  - Network: 1Gbps+ connection
  - Storage: 50GB+ SSD

- **Database**:
  - DragonflyDB (Redis-compatible): Port 6379
  - PostgreSQL 17: Port 5432

- **SSL/TLS Certificates**:
  - Valid SSL certificate for WSS connections
  - CA certificate for client validation

### Software Requirements
- Python 3.11+
- FastAPI 0.115.5+
- WebSocket support
- OpenSSL 1.1.1+

---

## P2P Coordinator Deployment

### Step 1: Server Setup

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install dependencies
sudo apt install -y python3.11 python3-pip nginx certbot

# Clone repository
cd /opt
git clone https://github.com/iskandarsulaili/rathena-AI-world.git
cd rathena-AI-world/p2p-coordinator

# Install Python dependencies
pip3 install -r requirements.txt
```

### Step 2: Configure Environment

Create `/opt/rathena-AI-world/p2p-coordinator/.env`:

```env
# Server Configuration
HOST=0.0.0.0
PORT=8001
WORKERS=4

# Database Configuration
DRAGONFLY_HOST=localhost
DRAGONFLY_PORT=6379
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=p2p_coordinator
POSTGRES_USER=p2p_user
POSTGRES_PASSWORD=<secure_password>

# Security
SECRET_KEY=<generate_secure_key>
ALLOWED_ORIGINS=https://yourdomain.com

# Logging
LOG_LEVEL=INFO
LOG_FILE=/var/log/p2p-coordinator/app.log
```

### Step 3: Start Services

```bash
# Start DragonflyDB
sudo systemctl start dragonfly
sudo systemctl enable dragonfly

# Start PostgreSQL
sudo systemctl start postgresql
sudo systemctl enable postgresql

# Start P2P Coordinator (using systemd)
sudo cp p2p-coordinator.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl start p2p-coordinator
sudo systemctl enable p2p-coordinator
```

---

## SSL/TLS Configuration

### Step 1: Obtain SSL Certificate

```bash
# Using Let's Encrypt
sudo certbot certonly --nginx -d coordinator.yourdomain.com

# Certificates will be at:
# /etc/letsencrypt/live/coordinator.yourdomain.com/fullchain.pem
# /etc/letsencrypt/live/coordinator.yourdomain.com/privkey.pem
```

### Step 2: Configure Nginx Reverse Proxy

Create `/etc/nginx/sites-available/p2p-coordinator`:

```nginx
upstream p2p_coordinator {
    server 127.0.0.1:8001;
}

server {
    listen 443 ssl http2;
    server_name coordinator.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/coordinator.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/coordinator.yourdomain.com/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location /api/signaling/ws {
        proxy_pass http://p2p_coordinator;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket timeouts
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    location /health {
        proxy_pass http://p2p_coordinator;
    }
}

server {
    listen 80;
    server_name coordinator.yourdomain.com;
    return 301 https://$server_name$request_uri;
}
```

Enable site:
```bash
sudo ln -s /etc/nginx/sites-available/p2p-coordinator /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## Client Integration

### Step 1: Update Configuration

Update `Data/config.ini`:

```ini
[P2P]
Enabled=1
CoordinatorURL=wss://coordinator.yourdomain.com/api/signaling/ws
PeerID=<auto-generated>
SessionID=<game-session-id>

[STUN]
Server1=stun:stun.l.google.com:19302
Server2=stun:stun1.l.google.com:19302

[TURN]
Server1=turn:turn.yourdomain.com:3478
Username=<turn-username>
Password=<turn-password>

[Security]
EnableEncryption=1
RequireCertificates=1
CACertPath=certs/ca.pem
```

### Step 2: Deploy Client Update

1. Build client with P2P integration
2. Test on staging environment
3. Gradual rollout (10% → 50% → 100%)
4. Monitor error rates and performance

---

## Monitoring and Logging

### Prometheus Metrics

Install Prometheus exporter:

```bash
pip3 install prometheus-fastapi-instrumentator
```

Add to coordinator:

```python
from prometheus_fastapi_instrumentator import Instrumentator

app = FastAPI()
Instrumentator().instrument(app).expose(app)
```

### Grafana Dashboard

Import dashboard for:
- Active connections
- Messages per second
- Latency percentiles (p50, p95, p99)
- Error rates
- Resource usage

### Log Aggregation

Configure log shipping to ELK stack or similar:

```bash
# Install Filebeat
sudo apt install filebeat

# Configure /etc/filebeat/filebeat.yml
filebeat.inputs:
- type: log
  paths:
    - /var/log/p2p-coordinator/*.log
  
output.elasticsearch:
  hosts: ["elasticsearch.yourdomain.com:9200"]
```

---

## Rollback Procedures

### Emergency Rollback

```bash
# 1. Disable P2P in client config (server-side flag)
curl -X POST https://api.yourdomain.com/admin/disable-p2p

# 2. Stop coordinator
sudo systemctl stop p2p-coordinator

# 3. Clients will automatically fallback to traditional server
# (verify fallback logic is working)

# 4. Investigate issues
sudo journalctl -u p2p-coordinator -n 1000

# 5. Fix and redeploy when ready
```

### Gradual Rollback

```bash
# Reduce percentage of users with P2P enabled
# Update feature flag: p2p_enabled_percentage = 0
```

---

## Disaster Recovery

### Backup Procedures

```bash
# Daily PostgreSQL backup
pg_dump -U p2p_user p2p_coordinator > backup_$(date +%Y%m%d).sql

# DragonflyDB snapshot (automatic)
# Configured in dragonfly.conf: save 900 1
```

### Recovery Procedures

```bash
# Restore PostgreSQL
psql -U p2p_user p2p_coordinator < backup_20251107.sql

# Restore DragonflyDB
# Copy dump.rdb to data directory and restart
```

### High Availability Setup

- Deploy coordinator across multiple availability zones
- Use load balancer for WebSocket connections
- Configure database replication
- Implement health checks and automatic failover

---

## Production Checklist

- [ ] SSL/TLS certificates installed and valid
- [ ] Nginx reverse proxy configured
- [ ] Firewall rules configured (allow 443, 8001)
- [ ] Monitoring and alerting set up
- [ ] Log aggregation configured
- [ ] Backup procedures tested
- [ ] Rollback procedures documented and tested
- [ ] Load testing completed (50+ concurrent peers)
- [ ] Security audit completed
- [ ] Disaster recovery plan documented
- [ ] On-call rotation established
- [ ] Runbook created for common issues

---

**Document Version**: 1.0  
**Last Updated**: 2025-11-07  
**Maintained By**: DevOps Team

