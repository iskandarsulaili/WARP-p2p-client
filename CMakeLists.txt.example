# CMakeLists.txt for Ragnarok Online Client with P2P WebSocket Support
# This is a reference implementation for integrating P2P coordinator signaling

cmake_minimum_required(VERSION 3.15)
project(RagnarokOnlineClient VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# P2P WebSocket Support Option
option(ENABLE_P2P "Enable P2P hosting support with WebSocket signaling" ON)

# Find required packages
find_package(Qt5 REQUIRED COMPONENTS Core Gui Network Widgets)
find_package(OpenSSL REQUIRED)

if(ENABLE_P2P)
    message(STATUS "P2P WebSocket support enabled")
    add_definitions(-DENABLE_P2P_SUPPORT)
    
    # Find WebSocket++ (header-only library)
    find_path(WEBSOCKETPP_INCLUDE_DIR
        NAMES websocketpp/config/asio_client.hpp
        PATHS 
            /usr/include 
            /usr/local/include
            ${CMAKE_SOURCE_DIR}/3rdparty/websocketpp
    )
    
    if(NOT WEBSOCKETPP_INCLUDE_DIR)
        message(FATAL_ERROR "WebSocket++ not found. Install with: sudo apt-get install libwebsocketpp-dev")
    endif()
    
    # Find nlohmann/json (header-only library)
    find_path(JSON_INCLUDE_DIR
        NAMES nlohmann/json.hpp
        PATHS 
            /usr/include 
            /usr/local/include
            ${CMAKE_SOURCE_DIR}/3rdparty/json
    )
    
    if(NOT JSON_INCLUDE_DIR)
        message(FATAL_ERROR "nlohmann/json not found. Install with: sudo apt-get install nlohmann-json3-dev")
    endif()
    
    # Find Asio (header-only library, required by WebSocket++)
    find_path(ASIO_INCLUDE_DIR
        NAMES asio.hpp
        PATHS 
            /usr/include 
            /usr/local/include
            ${CMAKE_SOURCE_DIR}/3rdparty/asio
    )
    
    if(NOT ASIO_INCLUDE_DIR)
        message(FATAL_ERROR "Asio not found. Install with: sudo apt-get install libasio-dev")
    endif()
    
    message(STATUS "WebSocket++ found: ${WEBSOCKETPP_INCLUDE_DIR}")
    message(STATUS "nlohmann/json found: ${JSON_INCLUDE_DIR}")
    message(STATUS "Asio found: ${ASIO_INCLUDE_DIR}")
    
    # P2P source files
    set(P2P_SOURCES
        Core/Network/P2PNetwork.cpp
        Core/Network/P2PSession.cpp
        Core/Game/MapSystem_P2P.cpp
    )
    
    set(P2P_HEADERS
        Core/Network/P2PNetwork.hpp
        Core/Network/P2PSession.hpp
    )
else()
    message(STATUS "P2P WebSocket support disabled")
    set(P2P_SOURCES "")
    set(P2P_HEADERS "")
endif()

# Client source files
set(CLIENT_SOURCES
    src/main.cpp
    src/game/GameEngine.cpp
    src/network/NetworkManager.cpp
    src/graphics/Renderer.cpp
    ${P2P_SOURCES}
)

set(CLIENT_HEADERS
    src/game/GameEngine.hpp
    src/network/NetworkManager.hpp
    src/graphics/Renderer.hpp
    ${P2P_HEADERS}
)

# Create executable
add_executable(client ${CLIENT_SOURCES} ${CLIENT_HEADERS})

# Include directories
target_include_directories(client PRIVATE
    ${CMAKE_SOURCE_DIR}/src
    ${CMAKE_SOURCE_DIR}/Core
    ${Qt5Core_INCLUDE_DIRS}
    ${Qt5Gui_INCLUDE_DIRS}
    ${Qt5Network_INCLUDE_DIRS}
    ${Qt5Widgets_INCLUDE_DIRS}
)

if(ENABLE_P2P)
    target_include_directories(client PRIVATE
        ${WEBSOCKETPP_INCLUDE_DIR}
        ${JSON_INCLUDE_DIR}
        ${ASIO_INCLUDE_DIR}
    )
endif()

# Link libraries
target_link_libraries(client PRIVATE
    Qt5::Core
    Qt5::Gui
    Qt5::Network
    Qt5::Widgets
    OpenSSL::SSL
    OpenSSL::Crypto
)

if(UNIX)
    target_link_libraries(client PRIVATE pthread)
endif()

# Compiler flags
if(MSVC)
    target_compile_options(client PRIVATE /W4)
else()
    target_compile_options(client PRIVATE -Wall -Wextra -Wpedantic)
endif()

# Install targets
install(TARGETS client DESTINATION bin)
install(FILES Data/config.ini.example DESTINATION share/client)
install(FILES Data/resourceinfo.ini.example DESTINATION share/client)

# Print configuration summary
message(STATUS "")
message(STATUS "Configuration Summary:")
message(STATUS "  C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "  Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "  P2P Support: ${ENABLE_P2P}")
if(ENABLE_P2P)
    message(STATUS "  WebSocket++: ${WEBSOCKETPP_INCLUDE_DIR}")
    message(STATUS "  nlohmann/json: ${JSON_INCLUDE_DIR}")
    message(STATUS "  Asio: ${ASIO_INCLUDE_DIR}")
endif()
message(STATUS "")

